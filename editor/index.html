<html>
    <head>
        <meta charset="UTF-8">
        <title>NLS Editor</title>
        <script src="./node_modules/interactjs/dist/interact.js"></script>
        <script src="./node_modules/underscore/underscore.js"></script>
        <script src="./node_modules/jszip/dist/jszip.min.js"></script>
        <script src="./node_modules/jquery/dist/jquery.min.js"></script>
        <script src="./jquery-ui/jquery-ui.js"></script>
        <script src="./jquery-custom-select/dist/js/jquery.custom-select.js"></script>
        <script src="./build/script.js"></script>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
        <link href="./jquery-ui/jquery-ui.css" type="text/css" rel="stylesheet">
        <link href="./jquery-custom-select/dist/css/jquery.custom-select.css" type="text/css" rel="stylesheet">
        <link href="./node_modules/flexboxgrid/css/flexboxgrid.min.css" type="text/css" rel="stylesheet">
        <link href="./style.css" type="text/css" rel="stylesheet">

        <script>
            $(function() {
                var nlsEditor = new NLSEditor()

                $('#compile-project').click(function() {
                    var zip = new JSZip()
                    zip.file('index.html', Templates['generatedOutput.ejs'])
                    var jsdir = zip.folder('js')
                    jsdir.file('story.js', nlsEditor.createJs())
                    jsdir.file('non-linear-story.js', Templates['non-linear-story.js'])
                    zip.generateAsync({type: 'blob'}).then(function (blob) {
                        saveFile(blob, 'build.zip')
                    })
                })

                $('#save-project').click(function() {
                    saveFile(new Blob([ JSON.stringify(nlsEditor.exportProject()) ], { type: 'application/json' }), 'project.json')
                })
                
                var fileInput = $('<input type="file" accept=".json">')
                $('#open-project').click(function() {
                    fileInput.change(function(event) {
                        var reader = new FileReader()

                        reader.onload = function(e) {
                            nlsEditor.loadProject(JSON.parse(reader.result))
                        }

                        reader.readAsText(this.files[0])
                        fileInput = $('<input type="file" accept=".json">')
                    })
                    fileInput.click()
                })
            })

            function saveFile(blob, filename) {
                if (window.navigator.msSaveOrOpenBlob) {
                    window.navigator.msSaveOrOpenBlob(blob, filename);
                } else {
                    var a = $('<a></a>')
                    a.appendTo($('body'))
                    var url = window.URL.createObjectURL(blob)
                    a[0].href = url
                    a[0].download = filename
                    a[0].click()
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url)
                        a.remove()
                    }, 0)
                }
            }
        </script>
    </head>

    <body>
        <canvas id="grid" tabindex="1">Your browser does not support the HTML5 canvas</canvas>
        <div id="toolbar">
            <span id="settings" title="Project settings"><i class="fas fa-cog fa-lg"></i></span>
            <span id="open-project" title="Open project..."><i class="fas fa-folder-open fa-lg"></i></span>
            <span id="save-project" title="Save project..."><i class="fas fa-save fa-lg"></i></span>
            <span id="compile-project" title="Compile project..."><i class="fas fa-arrow-alt-circle-down fa-lg"></i></span>
        </div>
        <div id="lateral-menu"></div>
        <ul class="grid-context-menu">
        </ul>
        <ul class="lateral-menu-context-menu">
        </ul>
    </body>
</html>